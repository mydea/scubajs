/*! 
 * scuba.js 
 * 
 * author: Francesco Novy 
 * licence: MIT license 
 * https://github.com/mydea/scubajs 
 * v0.1.2 
 */

!function($){var offlineReadyEvent="offlineready",offlineStatusEvent="offlinestatuschange",queueStatusEvent="queuestatuschange",syncEvent="sync";$.scuba=function(options){var settings=$.extend({},$.scuba.defaults,options),offline=!1,databaseIsReady=!1,queueTimer=null,syncPaused=!1,syncInProgress=!1,ajaxOnline=$.ajax,Queue=function(){var items=[],namespace="scuba_queue",errorCount=0,_save=function(){window.localStorage.setItem(namespace,JSON.stringify(items))},_load=function(){var ls=window.localStorage.getItem(namespace);items=JSON.parse(ls)||[]},queueError=function(err){return"undefined"==typeof err?errorCount++:errorCount=parseInt(err),errorCount},hasError=function(){return errorCount>=3},enqueue=function(item){items.push(item),_save()},dequeue=function(){var item=items.shift();return _save(),item},length=function(){return items.length},first=function(){return items[0]||null},last=function(){return items[items.length-1]||null},getQueue=function(){return items},init=function(namespaceSet){"undefined"==typeof namespaceSet&&(namespaceSet="scuba_queue"),namespace=namespaceSet,_load()};return{enqueue:enqueue,dequeue:dequeue,length:length,first:first,last:last,init:init,getQueue:getQueue,queueError:queueError,hasError:hasError}}(),LocalDB=function(){var db=null,dbName="scuba",findAll=function(table){if(!databaseIsReady)return!1;var trans=db.transaction([table],"readonly"),store=trans.objectStore(table),keyRange=IDBKeyRange.lowerBound(0),request=store.openCursor(keyRange),deferred=new $.Deferred,resultCache=[];return request.onsuccess=function(e){var result=e.target.result;return result?(resultCache.push(result.value),void result["continue"]()):(deferred.resolve(resultCache),void(resultCache=null))},request.onerror=function(){deferred.reject("an error occured when trying to load all entries of table "+table)},deferred.promise()},findById=function(table,id){if(!databaseIsReady)return!1;id=""+id;var trans=db.transaction([table],"readonly"),store=trans.objectStore(table),request=store.get(id),deferred=new $.Deferred;return request.onsuccess=function(e){var result=e.target.result;deferred.resolve(result||null)},request.onerror=function(){deferred.reject("an error occured when trying to load the entries of table "+table+" with the id "+id)},deferred.promise()},findByAttributes=function(table,attrs){if(!databaseIsReady)return!1;var deferred=new $.Deferred;return findAll(table).then(function(data){var filteredData=$.grep(data,function(item){for(var i in attrs)if("string"==typeof attrs[i]){if(attrs[i].toLowerCase()!==(""+item[i]).toLowerCase())return!1}else if(attrs[i]!==item[i])return!1;return!0});deferred.resolve(filteredData)}),deferred.promise()},findCustom=function(table,func){if(!databaseIsReady)return!1;var deferred=new $.Deferred;return findAll(table).then(function(data){var filteredData=$.grep(data,function(item){return func(item)});deferred.resolve(filteredData)}),deferred.promise()},rowInsert=function(table,data,checkIfExists){var deferred=$.Deferred();if(!databaseIsReady)return!1;if("undefined"==typeof checkIfExists&&(checkIfExists=!0),data.id=""+data.id,checkIfExists)findById(table,data.id).then(function(item){if(item)return void deferred.resolve(null);{var trans=db.transaction([table],"readwrite"),store=trans.objectStore(table);store.put(data)}trans.oncomplete=function(){deferred.resolve(data)},trans.onerror=function(){deferred.reject("error")}});else{{var trans=db.transaction([table],"readwrite"),store=trans.objectStore(table);store.put(data)}trans.oncomplete=function(){deferred.resolve(data)},trans.onerror=function(){deferred.reject("error")}}return deferred.promise()},rowUpdate=function(table,id,data){var deferred=$.Deferred();return databaseIsReady?(id=""+id,data.id=""+data.id,3!==arguments.length?(console.error("rowUpdate() expects 3 parameters: table, id, data"),!1):(findById(table,id).then(function(item){if(!item)return void deferred.resolve(null);{var trans=db.transaction([table],"readwrite"),store=trans.objectStore(table);store.put(data)}trans.oncomplete=function(){deferred.resolve(data)},trans.onerror=function(){deferred.reject("error")}}),deferred.promise())):!1},rowDelete=function(table,id){var deferred=$.Deferred();return databaseIsReady?(id=""+id,findById(table,id).then(function(item){if(!item)return void deferred.resolve(!1);{var trans=db.transaction([table],"readwrite"),store=trans.objectStore(table);store["delete"](id)}trans.oncomplete=function(){deferred.resolve(!0)},trans.onerror=function(){deferred.reject("error")}}),deferred.promise()):!1},_initSchema=function(schema){databaseIsReady=!1;var request=indexedDB.deleteDatabase(dbName);request.onsuccess=function(){_createSchema(schema)},request.onerror=function(){}},cleanUp=function(){indexedDB.deleteDatabase(dbName)},_createSchema=function(schema){var request=indexedDB.open(dbName,(new Date).getTime());request.onupgradeneeded=function(){var i,objectStore,db=this.result;for(i=0;i<schema.length;i++)objectStore=db.createObjectStore(schema[i].table,{keyPath:"id",autoIncrement:!1})},request.onsuccess=function(){db=this.result,databaseIsReady=!0;var i,j,promises=[];for(i=0;i<schema.length;i++)for(j=0;j<schema[i].data.length;j++)promises.push(rowInsert(schema[i].table,schema[i].data[j],!1));$.Deferred();$.when.apply($,promises).done(function(){_transferOfflineReadyEvent(),clearTimeout(queueTimer),queueTimer=setTimeout(_workQueue,10)})},request.onerror=function(){}},_initOffline=function(){var request=indexedDB.open(dbName);request.onsuccess=function(){db=this.result,db.objectStoreNames.length?(databaseIsReady=!0,_transferOfflineReadyEvent()):(databaseIsReady=!0,_transferOfflineReadyEvent())},request.onerror=function(){}},_transferOfflineReadyEvent=function(){_emitOfflineReadyEvent(databaseIsReady)},init=function(schema){schema?_initSchema(schema):_initOffline()},setNamespace=function(namespace){dbName=namespace};return{findAll:findAll,findById:findById,findByAttributes:findByAttributes,findCustom:findCustom,rowInsert:rowInsert,rowUpdate:rowUpdate,rowDelete:rowDelete,init:init,setNamespace:setNamespace,cleanUp:cleanUp,databaseIsReady:function(){return databaseIsReady}}}();settings.localDBClass&&(LocalDB=settings.localDBClass),settings.routes||(settings.routes=[]);for(var i=0;i<settings.routes.length;i++)"function"!=typeof settings.routes[i].data&&(settings.routes[i].data=function(){var deferred=$.Deferred();return deferred.resolve([]),deferred.promise()}),"function"!=typeof settings.routes[i].format&&(settings.routes[i].format=function(data){return data}),"function"!=typeof settings.routes[i].action&&(settings.routes[i].action=function(){return null});settings.namespace&&LocalDB.setNamespace(settings.namespace),"function"!=typeof settings.onofflineready&&(settings.onofflineready=function(){}),"function"!=typeof settings.onsync&&(settings.onsync=function(){}),"function"!=typeof settings.onqueuestatuschange&&(settings.onqueuestatuschange=function(){}),"function"!=typeof settings.onofflinestatuschange&&(settings.onofflinestatuschange=function(){}),settings.noConflict="undefined"!=typeof settings.noConflict?!!settings.noConflict:!1;var _emitOfflineStatusChangeEvent=function(){settings.noConflict||$(window).trigger(offlineStatusEvent,[isOffline()]),settings.onofflinestatuschange(isOffline())},_emitOfflineReadyEvent=function(){settings.noConflict||$(window).trigger(offlineReadyEvent,[databaseIsReady]),settings.onofflineready(databaseIsReady)},_emitSyncEvent=function(){settings.noConflict||$(window).trigger(syncEvent,[syncInProgress]),settings.onsync(syncInProgress)},_emitQueueStatusEvent=function(){var obj={status:Queue.hasError()?"ERROR":"OK",nextElement:Queue.first(),queue:Queue.getQueue(),queueLength:Queue.length()};settings.noConflict||$(window).trigger(queueStatusEvent,[obj]),settings.onqueuestatuschange(obj)},_initLocalDB=function(data){if(!data)return LocalDB.init(null),offline=!0,_emitOfflineStatusChangeEvent(),!1;var i,schema=[],models=[];for(i in data)models.push(i),schema.push({table:i,data:data[i]});return settings.includeDefaultRoutes&&settings.apiBaseUrl&&_initDefaultRoutes(models),LocalDB.init(schema),!0},_initDefaultRoutes=function(models){var i,routes=settings.routes;for(i=0;i<models.length;i++)!function(){var tempUrl,j,m=models[i];for(tempUrl=settings.apiBaseUrl+"/"+m,j=0;j<routes.length;j++)if("get"===routes[j].type.toLowerCase()&&routes[j].route.toLowerCase()===tempUrl.toLowerCase())return;for(settings.routes.push({type:"get",route:tempUrl,data:function(){return this.findAll(m)}}),tempUrl=settings.apiBaseUrl+"/"+m+"/!!",j=0;j<routes.length;j++)if("get"===routes[j].type.toLowerCase()&&routes[j].route.toLowerCase()===tempUrl.toLowerCase())return;for(settings.routes.push({type:"get",route:tempUrl,data:function(options,id){return this.findById(m,id)}}),tempUrl=settings.apiBaseUrl+"/"+m,j=0;j<routes.length;j++)if("post"===routes[j].type.toLowerCase()&&routes[j].route.toLowerCase()===tempUrl.toLowerCase())return;for(settings.routes.push({type:"post",route:tempUrl,data:function(options){return this.findById(m,options.data.id)},action:function(options){return this.rowInsert(m,options.data)}}),tempUrl=settings.apiBaseUrl+"/"+m+"/!!",j=0;j<routes.length;j++)if("put"===routes[j].type.toLowerCase()&&routes[j].route.toLowerCase()===tempUrl.toLowerCase())return;for(settings.routes.push({type:"put",route:tempUrl,data:function(options,id){return this.findById(m,id)},action:function(options,id){return this.rowUpdate(m,id,options.data)}}),tempUrl=settings.apiBaseUrl+"/"+m+"/!!",j=0;j<routes.length;j++)if("delete"===routes[j].type.toLowerCase()&&routes[j].route.toLowerCase()===tempUrl.toLowerCase())return;settings.routes.push({type:"delete",route:tempUrl,data:function(){return null},action:function(options,id){return this.rowDelete(m,id)}})}()},_downSync=function(){var routes=settings.downSyncRoutes,openRoutes=routes.length,data={},abort=!1;setTimeout(function(){!abort&&openRoutes>0&&(abort=!0,_initLocalDB(null))},settings.downSyncTimeout),routes&&0!==routes.length||(abort=!0,_initLocalDB(null));for(var i=0;i<routes.length;i++)!function(route){"function"!=typeof route.success&&(route.success=function(data){return data}),ajaxOnline({url:route.url,success:function(response){if(!abort){var responseData=route.success(response);data=_mergeData(data,responseData),openRoutes--,0===openRoutes&&(_initLocalDB(data),console.timeEnd("downsync"))}},error:function(){abort||(console.timeEnd("downsync"),abort=!0,_initLocalDB(null))}})}(routes[i])},queueIsWorking=!1,_workQueue=function(){return!isOfflineReady()||syncPaused?(clearTimeout(queueTimer),queueTimer=setTimeout(_workQueue,settings.syncRetry),void(syncInProgress&&(syncInProgress=!1,_emitSyncEvent()))):queueIsWorking?(clearTimeout(queueTimer),void(queueTimer=setTimeout(_workQueue,10))):Queue.length()?Queue.hasError()?"continue"===settings.queueIfError.toLowerCase()?(_emitSyncEvent(),_emitQueueStatusEvent(),Queue.dequeue(),Queue.queueError(0),clearTimeout(queueTimer),void(queueTimer=setTimeout(_workQueue,10))):(syncInProgress=!1,_emitSyncEvent(),_emitQueueStatusEvent(),void("function"==typeof settings.queueIfError&&settings.queueIfError(Queue.getQueue()))):(queueIsWorking=!0,syncInProgress||(syncInProgress=!0,_emitSyncEvent()),void ajaxOnline(Queue.first()).then(function(){Queue.dequeue();queueIsWorking=!1,offline=!1,clearTimeout(queueTimer),queueTimer=setTimeout(_workQueue,10),_emitQueueStatusEvent()},function(e){return 0===e.readyState?(queueIsWorking=!1,clearTimeout(queueTimer),queueTimer=setTimeout(_workQueue,settings.syncRetry),offline=!0,void _emitOfflineStatusChangeEvent()):(Queue.queueError(),queueIsWorking=!1,clearTimeout(queueTimer),void(queueTimer=setTimeout(_workQueue,1e3)))})):(clearTimeout(queueTimer),queueTimer=setTimeout(_workQueue,settings.syncRetry),void(syncInProgress&&(syncInProgress=!1,_emitSyncEvent(),_emitQueueStatusEvent())))},_init=function(){settings.noConflict||($.ajaxOnline=ajaxOnline,$.ajax=ajax),Queue.init(settings.namespace),_downSync(),_workQueue()},ajax=function(){if(!LocalDB.databaseIsReady())return ajaxOnline.apply($,arguments);var options={};"string"==typeof arguments[0]?(options.url=arguments[0],"object"==typeof arguments[1]&&$.extend(options,arguments[1])):options=$.extend(options,arguments[0]),options.type="undefined"==typeof options.type||"post"!==options.type.toLowerCase()&&"put"!==options.type.toLowerCase()&&"update"!==options.type.toLowerCase()?"get":options.type.toLowerCase(),"function"!=typeof options.success&&(options.success=function(){}),"function"!=typeof options.error&&(options.error=function(){}),"function"!=typeof options.complete&&(options.complete=function(){});var fittingRoute=_getRoute(options.url,options.type);if(!fittingRoute)return ajaxOnline.apply($,arguments);if("function"!=typeof fittingRoute.route.action&&(fittingRoute.route.action=null),"function"!=typeof fittingRoute.route.data)return ajaxOnline.apply($,arguments);"function"!=typeof fittingRoute.route.format&&(fittingRoute.route.format=settings.defaultFormat);var reducedOptions={};for(var i in options)"function"!=typeof options[i]&&(reducedOptions[i]=options[i]);var params=fittingRoute.params.slice(1);params.unshift(reducedOptions);var scubaOptions=$.extend({},reducedOptions);scubaOptions.getParams=fittingRoute.getParams,"get"===options.type&&options.data&&(scubaOptions.getParams=$.extend({},scubaOptions.getParams,options.data));var actionPromise=null;fittingRoute.route.action&&(actionPromise=fittingRoute.route.action.apply(LocalDB,params)),("post"===options.type||"put"===options.type||"delete"===options.type)&&(Queue.enqueue(reducedOptions),_emitQueueStatusEvent(),clearTimeout(queueTimer),queueTimer=setTimeout(_workQueue,10));var getData=function(actionPromise){var jqXHR=$.Deferred();jqXHR.responseJSON={},jqXHR.responseText="",jqXHR.readyState=0,jqXHR.statusText="OK",jqXHR.status=200,jqXHR.getAllResponseHeaders=function(){},jqXHR.setRequestHeader=function(){},jqXHR.getResponseHeader=function(){},jqXHR.statusCode=function(){return this.status},jqXHR.abort=function(){},scubaOptions.jqXHR=jqXHR;var getDataFunction=function(){var response,params=fittingRoute.params.slice(1);params.unshift(scubaOptions);var data=fittingRoute.route.data.apply(LocalDB,params);return"function"==typeof fittingRoute.route.status,data?void data.then(function(data){response=fittingRoute.route.format(data,scubaOptions),jqXHR.readyState=4,jqXHR.resolve(response),options.success(response,"success",jqXHR),options.complete(jqXHR,"success")}).fail(function(e){"object"==typeof e&&(jqXHR.responseText=JSON.stringify(e),jqXHR.responseJSON=e),jqXHR.readyState=4,jqXHR.reject(jqXHR,"error",e),options.error(jqXHR,"error",e),options.complete(jqXHR,"error",e),console.error("error loading data")}):(response=fittingRoute.route.format(null,scubaOptions),jqXHR.readyState=4,jqXHR.resolve(response),options.success(response,"success",jqXHR),void options.complete(jqXHR,"success"))};return actionPromise?actionPromise.then(function(){getDataFunction()}):getDataFunction(),jqXHR},deferred=getData(actionPromise),promise=deferred.promise();return promise.success=deferred.done,promise.error=deferred.fail,promise.complete=deferred.done,promise},isOfflineReady=function(){return databaseIsReady},isOffline=function(){return offline},pauseSync=function(pause){return syncPaused="undefined"==typeof pause?!syncPaused:!!pause,syncPaused?clearTimeout(queueTimer):(clearTimeout(queueTimer),queueTimer=setTimeout(_workQueue,10)),syncPaused},cleanUp=function(){return LocalDB.cleanUp(),!0};_init();var _mergeData=function(data1,data2){var model,i,length,lookup;for(model in data2){for(data1[model]||(data1[model]=[]),lookup={},i=0,length=data1[model].length;length>i;i++)lookup[data1[model][i].id]=data1[model][i];for(i=0;i<data2[model].length;i++)"undefined"==typeof lookup[data2[model][i].id]&&data1[model].push(data2[model][i])}return data1},_parseURI=function(uri){settings.apiBaseUrl&&0!==uri.indexOf("http")&&(uri=settings.apiBaseUrl+uri);var parser=document.createElement("a");parser.href=uri;var path=parser.pathname;0===path.indexOf("/")&&(path=path.slice(1)),"/"===path.substr(path.length-1)&&(path=path.slice(0,path.length-1));var pathSegments=path.split("/");return{hash:parser.hash,searchParams:parser.search,host:parser.host,protocol:parser.protocol,path:path,pathSegments:pathSegments}},_getRoute=function(route,type){var i,j,k,tempParts,regex,matches,tmp,routes=settings.routes,routeParts=_parseURI(route),getParams={};for(i=0;i<routes.length;i++)if(routes[i].type.toLowerCase()===type.toLowerCase()||"any"===routes[i].type.toLowerCase()){for(tempParts=_parseURI(routes[i].route),j=0;j<tempParts.pathSegments.length;j++)"!!"===tempParts.pathSegments[j]&&(tempParts.pathSegments[j]="(\\w+|\\d+)");if(regex="^"+tempParts.pathSegments.join("\\/")+"$",regex=new RegExp(regex,"gi"),matches=regex.exec(routeParts.path)){if(tmp=routeParts.searchParams,tmp.length>0)for(tmp=tmp.substr(1),tmp=tmp.split("&"),k=0;k<tmp.length;k++)getParams[tmp[k].split("=")[0]]=tmp[k].split("=")[1]||null;return{route:routes[i],params:matches,getParams:getParams}}}return!1};return{cleanUp:cleanUp,LocalDB:LocalDB,Queue:Queue,ajax:ajax,isOffline:isOffline,isOfflineReady:isOfflineReady,pauseSync:pauseSync,onofflineready:function(f){settings.onofflineready=f},onofflinestatuschange:function(f){settings.onofflinestatuschange=f},onsync:function(f){settings.onsync=f},onqueuestatuschange:function(f){settings.onqueuestatuschange=f},queueContinue:function(){Queue.queueError(0),clearTimeout(queueTimer),queueTimer=setTimeout(_workQueue,10)}}},$.scuba.defaults={syncRetry:1e4,downSyncTimeout:1e4,remoteIfOnline:!1,includeDefaultRoutes:!1,apiBaseUrl:"",localDBClass:null,downSyncRoutes:[],routes:[],namespace:"scuba",noConflict:!1,queueIfError:"continue",defaultFormat:function(data){return data}}}(jQuery);